/* Gear_HalfToning.cpp
 * Copyright (C) 2004 Jean-Sebastien Senecal
 * This file is part of Drone.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 */

#include "Gear_HalfToning.h"
#include "Engine.h"

#include <iostream>

#include "GearMaker.h"

// Coefficient table.
const Gear_HalfToning::ThreeCoefficients Gear_HalfToning::COEFS_TABLE[256] = {
0.722222222222,     0.0,                 //    0
0.722222222222,     0.0,                 //    1
0.677419354839,     0.0,                 //    2
0.636363636364,     0.0,                 //    3
0.615384615385,     0.0,                 //    4
0.602564102564,     0.0384615384615,     //    5
0.589743589744,     0.0769230769231,     //    6
0.576923076923,     0.115384615385,      //    7
0.564102564103,     0.153846153846,      //    8
0.551282051282,     0.192307692308,      //    9
0.538461538462,     0.230769230769,      //    10
0.535256410256,     0.239316239316,      //    11
0.532051282051,     0.247863247863,      //    12
0.528846153846,     0.25641025641,       //    13
0.525641025641,     0.264957264957,      //    14
0.522435897436,     0.273504273504,      //    15
0.519230769231,     0.282051282051,      //    16
0.516025641026,     0.290598290598,      //    17
0.512820512821,     0.299145299145,      //    18
0.509615384615,     0.307692307692,      //    19
0.50641025641,      0.316239316239,      //    20
0.503205128205,     0.324786324786,      //    21
0.5,                0.333333333333,      //    22
0.496753246753,     0.329004329004,      //    23
0.493506493506,     0.324675324675,      //    24
0.49025974026,      0.320346320346,      //    25
0.487012987013,     0.316017316017,      //    26
0.483766233766,     0.311688311688,      //    27
0.480519480519,     0.307359307359,      //    28
0.477272727273,     0.30303030303,       //    29
0.474025974026,     0.298701298701,      //    30
0.470779220779,     0.294372294372,      //    31
0.467532467532,     0.290043290043,      //    32
0.464285714286,     0.285714285714,      //    33
0.461038961039,     0.281385281385,      //    34
0.457792207792,     0.277056277056,      //    35
0.454545454545,     0.272727272727,      //    36
0.456168831169,     0.280844155844,      //    37
0.457792207792,     0.288961038961,      //    38
0.459415584416,     0.297077922078,      //    39
0.461038961039,     0.305194805195,      //    40
0.462662337662,     0.313311688312,      //    41
0.464285714286,     0.321428571429,      //    42
0.465909090909,     0.329545454545,      //    43
0.467532467532,     0.337662337662,      //    44
0.469155844156,     0.345779220779,      //    45
0.470779220779,     0.353896103896,      //    46
0.472402597403,     0.362012987013,      //    47
0.474025974026,     0.37012987013,       //    48
0.475649350649,     0.378246753247,      //    49
0.477272727273,     0.386363636364,      //    50
0.478896103896,     0.394480519481,      //    51
0.480519480519,     0.402597402597,      //    52
0.482142857143,     0.410714285714,      //    53
0.483766233766,     0.418831168831,      //    54
0.48538961039,      0.426948051948,      //    55
0.487012987013,     0.435064935065,      //    56
0.488636363636,     0.443181818182,      //    57
0.49025974026,      0.451298701299,      //    58
0.491883116883,     0.459415584416,      //    59
0.493506493506,     0.467532467532,      //    60
0.49512987013,      0.475649350649,      //    61
0.496753246753,     0.483766233766,      //    62
0.498376623377,     0.491883116883,      //    63
0.5,                0.5,                 //    64
0.485576923077,     0.504807692308,      //    65
0.471153846154,     0.509615384615,      //    66
0.456730769231,     0.514423076923,      //    67
0.442307692308,     0.519230769231,      //    68
0.427884615385,     0.524038461538,      //    69
0.413461538462,     0.528846153846,      //    70
0.399038461538,     0.533653846154,      //    71
0.384615384615,     0.538461538462,      //    72
0.441025641026,     0.464102564103,      //    73
0.497435897436,     0.389743589744,      //    74
0.553846153846,     0.315384615385,      //    75
0.610256410256,     0.241025641026,      //    76
0.666666666667,     0.166666666667,      //    77
0.666666666667,     0.166666666667,      //    78
0.666666666667,     0.166666666667,      //    79
0.666666666667,     0.166666666667,      //    80
0.666666666667,     0.166666666667,      //    81
0.666666666667,     0.166666666667,      //    82
0.666666666667,     0.166666666667,      //    83
0.666666666667,     0.166666666667,      //    84
0.666666666667,     0.166666666667,      //    85
0.65,               0.18,                //    86
0.633333333333,     0.193333333333,      //    87
0.616666666667,     0.206666666667,      //    88
0.6,                0.22,                //    89
0.583333333333,     0.233333333333,      //    90
0.566666666667,     0.246666666667,      //    91
0.55,               0.26,                //    92
0.533333333333,     0.273333333333,      //    93
0.516666666667,     0.286666666667,      //    94
0.5,                0.3,                 //    95
0.5,                0.3,                 //    96
0.5,                0.3,                 //    97
0.5,                0.3,                 //    98
0.5,                0.3,                 //    99
0.5,                0.3,                 //    100
0.5,                0.3,                 //    101
0.5,                0.3,                 //    102
0.5,                0.3,                 //    103
0.5,                0.3,                 //    104
0.5,                0.3,                 //    105
0.5,                0.3,                 //    106
0.5,                0.3,                 //    107
0.508333333333,     0.293333333333,      //    108
0.516666666667,     0.286666666667,      //    109
0.525,              0.28,                //    110
0.533333333333,     0.273333333333,      //    111
0.541666666667,     0.266666666667,      //    112
0.55,               0.26,                //    113
0.558333333333,     0.253333333333,      //    114
0.566666666667,     0.246666666667,      //    115
0.575,              0.24,                //    116
0.583333333333,     0.233333333333,      //    117
0.591666666667,     0.226666666667,      //    118
0.6,                0.22,                //    119
0.608333333333,     0.213333333333,      //    120
0.616666666667,     0.206666666667,      //    121
0.625,              0.2,                 //    122
0.633333333333,     0.193333333333,      //    123
0.641666666667,     0.186666666667,      //    124
0.65,               0.18,                //    125
0.658333333333,     0.173333333333,      //    126
0.666666666667,     0.166666666667,      //    127
0.666666666667,     0.166666666667,      //    128
0.658333333333,     0.173333333333,      //    129
0.65,               0.18,                //    130
0.641666666667,     0.186666666667,      //    131
0.633333333333,     0.193333333333,      //    132
0.625,              0.2,                 //    133
0.616666666667,     0.206666666667,      //    134
0.608333333333,     0.213333333333,      //    135
0.6,                0.22,                //    136
0.591666666667,     0.226666666667,      //    137
0.583333333333,     0.233333333333,      //    138
0.575,              0.24,                //    139
0.566666666667,     0.246666666667,      //    140
0.558333333333,     0.253333333333,      //    141
0.55,               0.26,                //    142
0.541666666667,     0.266666666667,      //    143
0.533333333333,     0.273333333333,      //    144
0.525,              0.28,                //    145
0.516666666667,     0.286666666667,      //    146
0.508333333333,     0.293333333333,      //    147
0.5,                0.3,                 //    148
0.5,                0.3,                 //    149
0.5,                0.3,                 //    150
0.5,                0.3,                 //    151
0.5,                0.3,                 //    152
0.5,                0.3,                 //    153
0.5,                0.3,                 //    154
0.5,                0.3,                 //    155
0.5,                0.3,                 //    156
0.5,                0.3,                 //    157
0.5,                0.3,                 //    158
0.5,                0.3,                 //    159
0.5,                0.3,                 //    160
0.516666666667,     0.286666666667,      //    161
0.533333333333,     0.273333333333,      //    162
0.55,               0.26,                //    163
0.566666666667,     0.246666666667,      //    164
0.583333333333,     0.233333333333,      //    165
0.6,                0.22,                //    166
0.616666666667,     0.206666666667,      //    167
0.633333333333,     0.193333333333,      //    168
0.65,               0.18,                //    169
0.666666666667,     0.166666666667,      //    170
0.666666666667,     0.166666666667,      //    171
0.666666666667,     0.166666666667,      //    172
0.666666666667,     0.166666666667,      //    173
0.666666666667,     0.166666666667,      //    174
0.666666666667,     0.166666666667,      //    175
0.666666666667,     0.166666666667,      //    176
0.666666666667,     0.166666666667,      //    177
0.666666666667,     0.166666666667,      //    178
0.610256410256,     0.241025641026,      //    179
0.553846153846,     0.315384615385,      //    180
0.497435897436,     0.389743589744,      //    181
0.441025641026,     0.464102564103,      //    182
0.384615384615,     0.538461538462,      //    183
0.399038461538,     0.533653846154,      //    184
0.413461538462,     0.528846153846,      //    185
0.427884615385,     0.524038461538,      //    186
0.442307692308,     0.519230769231,      //    187
0.456730769231,     0.514423076923,      //    188
0.471153846154,     0.509615384615,      //    189
0.485576923077,     0.504807692308,      //    190
0.5,                0.5,                 //    191
0.498376623377,     0.491883116883,      //    192
0.496753246753,     0.483766233766,      //    193
0.49512987013,      0.475649350649,      //    194
0.493506493506,     0.467532467532,      //    195
0.491883116883,     0.459415584416,      //    196
0.49025974026,      0.451298701299,      //    197
0.488636363636,     0.443181818182,      //    198
0.487012987013,     0.435064935065,      //    199
0.48538961039,      0.426948051948,      //    200
0.483766233766,     0.418831168831,      //    201
0.482142857143,     0.410714285714,      //    202
0.480519480519,     0.402597402597,      //    203
0.478896103896,     0.394480519481,      //    204
0.477272727273,     0.386363636364,      //    205
0.475649350649,     0.378246753247,      //    206
0.474025974026,     0.37012987013,       //    207
0.472402597403,     0.362012987013,      //    208
0.470779220779,     0.353896103896,      //    209
0.469155844156,     0.345779220779,      //    210
0.467532467532,     0.337662337662,      //    211
0.465909090909,     0.329545454545,      //    212
0.464285714286,     0.321428571429,      //    213
0.462662337662,     0.313311688312,      //    214
0.461038961039,     0.305194805195,      //    215
0.459415584416,     0.297077922078,      //    216
0.457792207792,     0.288961038961,      //    217
0.456168831169,     0.280844155844,      //    218
0.454545454545,     0.272727272727,      //    219
0.457792207792,     0.277056277056,      //    220
0.461038961039,     0.281385281385,      //    221
0.464285714286,     0.285714285714,      //    222
0.467532467532,     0.290043290043,      //    223
0.470779220779,     0.294372294372,      //    224
0.474025974026,     0.298701298701,      //    225
0.477272727273,     0.30303030303,       //    226
0.480519480519,     0.307359307359,      //    227
0.483766233766,     0.311688311688,      //    228
0.487012987013,     0.316017316017,      //    229
0.49025974026,      0.320346320346,      //    230
0.493506493506,     0.324675324675,      //    231
0.496753246753,     0.329004329004,      //    232
0.5,                0.333333333333,      //    233
0.503205128205,     0.324786324786,      //    234
0.50641025641,      0.316239316239,      //    235
0.509615384615,     0.307692307692,      //    236
0.512820512821,     0.299145299145,      //    237
0.516025641026,     0.290598290598,      //    238
0.519230769231,     0.282051282051,      //    239
0.522435897436,     0.273504273504,      //    240
0.525641025641,     0.264957264957,      //    241
0.528846153846,     0.25641025641,       //    242
0.532051282051,     0.247863247863,      //    243
0.535256410256,     0.239316239316,      //    244
0.538461538462,     0.230769230769,      //    245
0.551282051282,     0.192307692308,      //    246
0.564102564103,     0.153846153846,      //    247
0.576923076923,     0.115384615385,      //    248
0.589743589744,     0.0769230769231,     //    249
0.602564102564,     0.0384615384615,     //    250
0.615384615385,     0.0,                 //    251
0.636363636364,     0.0,                 //    252
0.677419354839,     0.0,                 //    253
0.722222222222,     0.0,                 //    254
0.722222222222,     0.0};                //    255

extern "C" {
Gear* makeGear(Schema *schema, std::string uniqueName)
{
  return new Gear_HalfToning(schema, uniqueName);
}

GearInfo getGearInfo()
{
  GearInfo gearInfo;
  gearInfo.name = "HalfToning";
  gearInfo.classification = GearClassifications::video().color().instance();
  return gearInfo;
}
}

Gear_HalfToning::Gear_HalfToning(Schema *schema, std::string uniqueName)
: Gear(schema, "HalfToning", uniqueName), _carryLine0(0), _carryLine1(0)
{
  addPlug(_VIDEO_IN = new PlugIn<VideoRGBAType>(this, "ImgIN", true));
  addPlug(_VIDEO_OUT = new PlugOut<VideoRGBAType>(this, "ImgOUT", true));
  NOTICE("Pour le moment les coeffs tables ne sont pas pré-calculées... à corriger un jour.");
}

Gear_HalfToning::~Gear_HalfToning()
{
  free(_carryLine0);
  free(_carryLine1);
}

void Gear_HalfToning::runVideo()
{
  _image = _VIDEO_IN->type();
  if (_image->isNull())
    return;

  _outImage = _VIDEO_OUT->type();
  _outImage->resize(_image->width(), _image->height());

  _sizeX = _image->width();
  _sizeY = _image->height();

  _data = _image->data();    
  _outData = _outImage->data();

  _carryLine0 = (RGBAfloat*)realloc(_carryLine0, (_sizeX+2)*sizeof(RGBAfloat));
  _carryLine1 = (RGBAfloat*)realloc(_carryLine1, (_sizeX+2)*sizeof(RGBAfloat));
  memset(_carryLine0, 0, (_sizeX+2)*sizeof(RGBAfloat));
  memset(_carryLine1, 0, (_sizeX+2)*sizeof(RGBAfloat));

  unsigned char *iterData;
  unsigned char *iterOutData;
  float *iterCarryLine0;
  float *iterCarryLine1;

  int xstart, xstop, xstep, dir, iterDataStep;
  int input, intensity;
  float threshold = 127.5, corrected_level, diff;

  float term_r, term_dl, term_d;
  ThreeCoefficients coefs;

  for (int y = 0; y < _sizeY; ++y)
  {
    if (y & 1)
    {
      // odd line
      dir = -4;
      xstart = _sizeX-1; xstop = -1; xstep = -1; iterDataStep = -7;
    } else
    {
      // even line
      dir = 4;
      xstart = 0; xstop = _sizeX; xstep = 1; iterDataStep = 1;
    }

    iterData    = (unsigned char*)&_data[y*_sizeX+xstart];
    iterOutData = (unsigned char*)&_outData[y*_sizeX+xstart];

    iterCarryLine0 = (float*)&_carryLine0[xstart+1];
    iterCarryLine1 = (float*)&_carryLine1[xstart+1];

    for (int x = xstart; x != xstop; x += xstep)
    {
      for (int z=0; z<3; ++z)
      {
        input = (int) *iterData;

        // Correct level.
        corrected_level = input + *iterCarryLine0;

        // Compute intensity.
        intensity = (corrected_level > threshold ? 255 : 0);

        // Distribute error.

        diff = corrected_level - intensity;

        coefs = COEFS_TABLE[input];

        term_r = coefs.i_r*diff;
        term_dl = coefs.i_dl*diff;
        term_d = diff - (term_r+term_dl);

        *(iterCarryLine0+dir) += term_r;
        *(iterCarryLine1-dir) += term_dl;
        *(iterCarryLine1)     += term_d;

        // Put color.
        *iterOutData = (input & intensity ? 255 : 0);

        ++iterData;
        ++iterOutData;
        ++iterCarryLine0;
        ++iterCarryLine1;
      }

      iterData       += iterDataStep;
      iterOutData    += iterDataStep;
      iterCarryLine0 += iterDataStep;
      iterCarryLine1 += iterDataStep;
    }

    // Shift carry buffers.
    RGBAfloat *tmp = _carryLine0;
    _carryLine0 = _carryLine1;
    _carryLine1 = tmp;
    memset(_carryLine1, 0, (_sizeX+2)*sizeof(RGBAfloat));

  }

}

